"use strict";(()=>{var e={};e.id=869,e.ids=[869],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5478:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>T,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>h,dynamic:()=>m,runtime:()=>p});var o=r(9303),n=r(8716),i=r(670),l=r(7070),s=r(912),c=r(6517),u=r(2851);let p="nodejs",m="force-dynamic";async function h(e,{params:t}){try{let{searchParams:r}=new URL(e.url),a=Math.max(1,Math.min(50,parseInt(r.get("last")||"25",10))),o=`${(0,s.v2)()}/players/${(0,s.xy)(t.tag)}/battlelog`;console.log("Fetching battles from:",o),console.log("BaseURL",(0,s.v2)(),process.env.USE_PROXY,!!process.env.SUPERCELL_TOKEN);let n=await (0,u.q)(o,{headers:(0,s.$V)()});if(!n.ok){let e=await n.text().catch(()=>"");return console.error("Supercell API error",n.status,e),l.NextResponse.json({error:!0,status:n.status,body:e||n.statusText},{status:n.status})}let i=await n.json();console.log(`Fetched ${i.length} battles for ${t.tag}`),console.log("Latest battle time:",i[0]?.battleTime);let p=i.slice(0,a).map(c.d);console.log("Normalized battles count:",p.length),console.log("Latest normalized battle:",p[0]?.battleTimeFormatted);let m=l.NextResponse.json(p);return m.headers.set("Cache-Control","private, max-age=15"),m}catch(e){return console.error("Route crash",e),l.NextResponse.json({code:500,message:e.message||"Internal error"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/player/[tag]/battles/route",pathname:"/api/player/[tag]/battles",filename:"route",bundlePath:"app/api/player/[tag]/battles/route"},resolvedPagePath:"/home/project/app/api/player/[tag]/battles/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:y}=d,T="/api/player/[tag]/battles/route";function b(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},2851:(e,t,r)=>{r.d(t,{q:()=>a});async function a(e,t={},r={}){let a=r.timeoutMs??1e4,o=r.retries??2;for(let r=0;r<=o;r++){let n=new AbortController,i=setTimeout(()=>n.abort(),a);try{let r=await fetch(e,{...t,cache:"no-store",signal:n.signal,headers:{Accept:"application/json","User-Agent":"clash-next/1.0",...t.headers||{}}});return clearTimeout(i),r}catch(t){if(clearTimeout(i),r===o)throw t;let e=300*(r+1)+Math.floor(200*Math.random());await new Promise(t=>setTimeout(t,e))}}throw Error("unreachable")}},6517:(e,t,r)=>{r.d(t,{e:()=>s,d:()=>l});let a="America/Sao_Paulo";function o(e){if(!e||"string"!=typeof e)return null;if(/^\d{4}-\d{2}-\d{2}T/.test(e)){let t=new Date(e);return isNaN(t.getTime())?null:t}let t=e.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(\.\d+)?Z$/);if(!t)return null;let[,r,a,o,n,i,l,s=".000"]=t,c=new Date(`${r}-${a}-${o}T${n}:${i}:${l}${s}Z`);return isNaN(c.getTime())?null:c}let n=["localeMatcher","weekday","era","year","month","day","hour","minute","second","timeZoneName","formatMatcher","hour12","timeZone","calendar","numberingSystem","dateStyle","timeStyle","hourCycle","dayPeriod","fractionalSecondDigits"];function i(e,t,r=a){if(!e)return"--";let i="string"==typeof e?o(e):new Date(e);if(!i||isNaN(i.getTime()))return"--";let l=function(e,t=a){let r=new Date(e.toLocaleString("en-US",{timeZone:t})),o=e.getTime()-r.getTime();return new Date(e.getTime()-o)}(i,r),s=function(e,t=a){let r={};if(e&&"object"==typeof e)for(let t of n){let a=e[t];void 0!==a&&(r[t]=a)}return r.timeZone=t,void 0===r.dateStyle&&void 0===r.timeStyle&&(r.dateStyle="short",r.timeStyle="short"),r}(t,r);try{return new Intl.DateTimeFormat("pt-BR",s).format(l)}catch{try{return l.toLocaleString("pt-BR",{timeZone:r})}catch{return"--"}}}function l(e){let t=e?.team?.[0]??{},r=e?.opponent?.[0]??{},a=t.crowns??0,o=r.crowns??0,n=i(e.battleTime);return{battleTime:e.battleTime,battleTimeFormatted:n,gameMode:e.gameMode?.name??"",result:a>o?"WIN":a<o?"LOSS":"DRAW",crownsFor:a,crownsAgainst:o,opponentName:r.name??"",opponentTag:(r.tag??"").replace("#",""),opponentTrophies:r.startingTrophies??0,teamDeck:(t.cards||[]).map(e=>e.name),opponentDeck:(r.cards||[]).map(e=>e.name),trophyChange:t.trophyChange??0}}function s(e,t){let r=t.filter(e=>o(e.battleTime)).sort((e,t)=>{let r=o(e.battleTime),a=o(t.battleTime);return r&&a?a.getTime()-r.getTime():0}),a=[...r].reverse(),n=e.trophies;for(let e of r)n-=e.trophyChange||0;let l=n,s=[];for(let e of a)l+=e.trophyChange||0,s.push({label:i(e.battleTime,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),trophies:l});let c=r.filter(e=>"WIN"===e.result).length,u=r.filter(e=>"LOSS"===e.result).length,p=a[0]?.battleTime,m=a[a.length-1]?.battleTime,h=0;if(p&&m){let e=o(p),t=o(m);e&&t&&(h=t.getTime()-e.getTime())}return{tag:(e.tag||"").replace("#",""),name:e.name,trophiesNow:e.trophies,trophiesStart:n,trophyDelta:e.trophies-n,matchesTotal:r.length,wins:c,losses:u,winRate:r.length?Math.round(c/r.length*100):0,pushDurationMs:h,series:s}}},912:(e,t,r)=>{function a(){return"false"===process.env.USE_PROXY?"https://api.clashroyale.com/v1":"https://proxy.royaleapi.dev/v1"}function o(e){return`%23${String(e).replace(/^#/,"").toUpperCase()}`}function n(){if(!process.env.SUPERCELL_TOKEN)throw Error("Missing SUPERCELL_TOKEN env");return{Authorization:`Bearer ${process.env.SUPERCELL_TOKEN}`}}r.d(t,{$V:()=>n,v2:()=>a,xy:()=>o})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972],()=>r(5478));module.exports=a})();