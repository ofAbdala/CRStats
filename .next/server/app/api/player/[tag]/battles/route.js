"use strict";(()=>{var e={};e.id=869,e.ids=[869],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5478:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>T,patchFetch:()=>b,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{GET:()=>h,dynamic:()=>m,runtime:()=>u});var o=a(9303),n=a(8716),i=a(670),s=a(7070),l=a(912),c=a(6517),p=a(2851);let u="nodejs",m="force-dynamic";async function h(e,{params:t}){try{let{searchParams:a}=new URL(e.url),r=Math.max(1,Math.min(50,parseInt(a.get("last")||"25",10))),o=`${(0,l.v2)()}/players/${(0,l.xy)(t.tag)}/battlelog`;console.log("Fetching battles from:",o),console.log("BaseURL",(0,l.v2)(),process.env.USE_PROXY,!!process.env.SUPERCELL_TOKEN);let n=await (0,p.q)(o,{headers:(0,l.$V)()});if(!n.ok){let e=await n.text().catch(()=>"");return console.error("Supercell API error",n.status,e),s.NextResponse.json({error:!0,status:n.status,body:e||n.statusText},{status:n.status})}let i=await n.json();console.log(`Fetched ${i.length} battles for ${t.tag}`),console.log("Latest battle time:",i[0]?.battleTime);let u=i.slice(0,r).map(c.d);console.log("Normalized battles count:",u.length),console.log("Latest normalized battle:",u[0]?.battleTimeFormatted);let m=s.NextResponse.json(u);return m.headers.set("Cache-Control","private, max-age=15"),m}catch(e){return console.error("Route crash",e),s.NextResponse.json({code:500,message:e.message||"Internal error"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/player/[tag]/battles/route",pathname:"/api/player/[tag]/battles",filename:"route",bundlePath:"app/api/player/[tag]/battles/route"},resolvedPagePath:"/home/project/app/api/player/[tag]/battles/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:y}=d,T="/api/player/[tag]/battles/route";function b(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},2851:(e,t,a)=>{a.d(t,{q:()=>r});async function r(e,t={},a={}){let r=a.timeoutMs??1e4,o=a.retries??2;for(let a=0;a<=o;a++){let n=new AbortController,i=setTimeout(()=>n.abort(),r);try{let a=await fetch(e,{...t,cache:"no-store",signal:n.signal,headers:{Accept:"application/json","User-Agent":"clash-next/1.0",...t.headers||{}}});return clearTimeout(i),a}catch(t){if(clearTimeout(i),a===o)throw t;let e=300*(a+1)+Math.floor(200*Math.random());await new Promise(t=>setTimeout(t,e))}}throw Error("unreachable")}},6517:(e,t,a)=>{a.d(t,{e:()=>s,d:()=>i});var r={};a.r(r),a.d(r,{o0:()=>n});let o=["localeMatcher","calendar","numberingSystem","timeZone","hour12","hourCycle","formatMatcher","weekDay","weekday","era","year","month","day","hour","minute","second","timeZoneName","dayPeriod","fractionalSecondDigits"];function n(e,t={}){let a=function(e){if(null==e)return null;let t=e instanceof Date?e:new Date(e);return isNaN(t.getTime())?null:t}(e);return a?function(e,t){try{return new Intl.DateTimeFormat("pt-BR",t).format(e)}catch{let a={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:t.timeZone??"America/Sao_Paulo",hour12:!1};return new Intl.DateTimeFormat("pt-BR",a).format(e)}}(a,function(e){let t={},a={...e};for(let e of(void 0!==a.weekDay&&void 0===a.weekday&&(a.weekday=a.weekDay),o)){let r=a[e];void 0!==r&&(t[e]=r)}return t}({timeZone:"America/Sao_Paulo",...t})):"â€”"}function i(e){let t=e?.team?.[0]??{},a=e?.opponent?.[0]??{},r=t.crowns??0,o=a.crowns??0,i=n(e.battleTime);return{battleTime:e.battleTime,battleTimeFormatted:i,gameMode:e.gameMode?.name??"",result:r>o?"WIN":r<o?"LOSS":"DRAW",crownsFor:r,crownsAgainst:o,opponentName:a.name??"",opponentTag:(a.tag??"").replace("#",""),opponentTrophies:a.startingTrophies??0,teamDeck:(t.cards||[]).map(e=>e.name),opponentDeck:(a.cards||[]).map(e=>e.name),trophyChange:t.trophyChange??0}}function s(e,t){let a=t.filter(e=>(0,r.parseClashTime)(e.battleTime)).sort((e,t)=>{let a=(0,r.parseClashTime)(e.battleTime),o=(0,r.parseClashTime)(t.battleTime);return a&&o?o.getTime()-a.getTime():0}),o=[...a].reverse(),i=e.trophies;for(let e of a)i-=e.trophyChange||0;let s=i,l=[];for(let e of o)s+=e.trophyChange||0,l.push({label:n(e.battleTime,{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}),trophies:s});let c=a.filter(e=>"WIN"===e.result).length,p=a.filter(e=>"LOSS"===e.result).length,u=o[0]?.battleTime,m=o[o.length-1]?.battleTime,h=0;if(u&&m){let e=(0,r.parseClashTime)(u),t=(0,r.parseClashTime)(m);e&&t&&(h=t.getTime()-e.getTime())}return{tag:(e.tag||"").replace("#",""),name:e.name,trophiesNow:e.trophies,trophiesStart:i,trophyDelta:e.trophies-i,matchesTotal:a.length,wins:c,losses:p,winRate:a.length?Math.round(c/a.length*100):0,pushDurationMs:h,series:l}}},912:(e,t,a)=>{function r(){return"false"===process.env.USE_PROXY?"https://api.clashroyale.com/v1":"https://proxy.royaleapi.dev/v1"}function o(e){return`%23${String(e).replace(/^#/,"").toUpperCase()}`}function n(){if(!process.env.SUPERCELL_TOKEN)throw Error("Missing SUPERCELL_TOKEN env");return{Authorization:`Bearer ${process.env.SUPERCELL_TOKEN}`}}a.d(t,{$V:()=>n,v2:()=>r,xy:()=>o})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(5478));module.exports=r})();